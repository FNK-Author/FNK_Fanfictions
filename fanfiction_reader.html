<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fanfictions by FNK</title>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      background-color: #00000F;
      color: white;
      font-family: 'EB Garamond', Garamond, serif;
      text-align: center;
      zoom: 1;
    }
    h1 {
      font-size: 25px;
      margin-top: 20px;
    }
    .highlight {
      color: #EFB734;
      text-decoration: none;
    }
    select, button, input[type="range"] {
      background-color: #EFD6A5;
      color: black;
      font-weight: bold;
      font-size: 16px;
      padding: 10px;
      margin: 10px;
      border: none;
      border-radius: 5px;
      max-width: 600px;
      width: 90%;
      cursor: pointer;
    }
    input[type="range"] {
      -webkit-appearance: none;
      height: 5px;
      padding: 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #EFB734;
      cursor: pointer;
    }
    .textbox {
      margin: 10px auto;
      border: 5px solid white;
      width: 90%;
      max-width: 600px;
      aspect-ratio: 3/4;
      overflow-y: auto;
      padding: 15px;
      background-color: transparent;
      text-align: left;
      counter-reset: linenumber;
      font-size: 1.5em;
      position: relative;
    }
    .textbox .line {
      counter-increment: linenumber;
      position: relative;
      padding-left: 25px;
      white-space: pre-wrap;
    }
    .textbox .line::before {
      content: counter(linenumber);
      position: absolute;
      left: 0;
      width: 0em;
      text-align: left;
      color: #FFC90E;
      font-size: 20px;
    }
    .textbox .line.playing::before {
      color: #FFC90E;
      font-weight: bold;
    }
    .volume-container {
      max-width: 600px;
      margin: 0 auto 20px;
    }
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      max-width: 600px;
      margin: 0 auto 30px;
      padding: 0 10px;
    }
    .autoscroll-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      max-width: 600px;
      margin: 10px auto;
    }
    .arrow {
      font-size: 30px;
      cursor: pointer;
      user-select: none;
    }
    audio {
      display: none;
    }
    .textbox img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 10px auto;
    }
  </style>
</head>
<body>
  <h1>Fanfictions by <a class="highlight" href="https://linktr.ee/fnk_fanfics" target="_blank">FNK</a></h1>

  <select id="storySelect">
    <option disabled selected>Wähle eine Geschichte</option>
  </select>

  <select id="chapterSelect">
    <option disabled selected>Kapitel wählen</option>
  </select>

  <div class="autoscroll-buttons">
    <button id="autoscrollPlus">Autoscroll +</button>
    <button id="autoscrollMinus">Autoscroll -</button>
  </div>

  <div class="textbox" id="storyContent">
    Bitte gib dem Kapitel oder der Fanfiction nach dem Lesen ein Upvote. Klicke dazu oben auf das FNK. Danke!
  </div>

  <div class="volume-container">
    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" />
  </div>

  <div class="nav-buttons">
    <div class="arrow" onclick="changeChapter(-1)">←</div>
    <div class="arrow" onclick="changeChapter(1)">→</div>
  </div>

  <audio id="audioTrigger" loop></audio>

  <script>
    const stories = {
      "Die Hexe in der Nacht (Harry Potter)": {
        prefix: "dhidn_",
        chapters: [
          "Der Fang seines Lebens","Die Regelbrecher","Missetat begangen","Die Feier","Neugier",
          "Das Geheimnis","Der Trank","Der Sturm","Ein Wunsch geht in Erfüllung","Bis wir uns irgendwann wiedersehen und zusammenwachsen",
          "Geschichten in der Hütte","Die Nacht ist noch nicht vorbei","Apfel-Zimt","Hirsch und Pferd","Die Schuld",
          "Pfefferminz Melodie","Eine kleine Ewigkeit","Eskalation - Teil 1","Eskalation - Teil 2","Träumerei",
          "Tunichtgut","Erinnerungslücken","Unverzeihlich","Der Tiefpunkt","Felicity - Teil 1: Das Geheimnis",
          "Felicity - Teil 2: Die Freundschaft","Felicity - Teil 3: Der Unfall","Felicity - Teil 4: Das Portrait","Ein offenes Ohr","Therapie",
          "Solo","Der Hexentag - Teil 1","Der Hexentag - Teil 2","Der Hexentag - Teil 3","Der Hexentag - Teil 4"
        ],
        triggers: {
          0: [
            { line: 1, music: "yk0739" },
            { line: 5, image: "https://github.com/FNK-Author/FNK_Fanfictions/blob/408317a24ddb58b06c98177444c322d3e950946d/Illustration_DHIDN_3840x2160_600dpi.png" }
          ],
          1: [{ line: 1, music: "5bgsn9" }],
          2: [{ line: 1, music: "h0ok1d" }],
          3: [{ line: 1, music: "aikb5w" }],
          4: [{ line: 1, music: "" }],
          5: [{ line: 1, music: "" }],
          6: [{ line: 1, music: "" }],
          7: [{ line: 1, music: "" }],
          8: [{ line: 1, music: "" }],
          9: [{ line: 1, music: "" }],
          10: [{ line: 1, music: "" }],
          11: [{ line: 1, music: "" }],
          12: [{ line: 1, music: "" }],
          13: [{ line: 1, music: "" }],
          14: [{ line: 1, music: "" }],
          15: [{ line: 1, music: "" }],
          16: [{ line: 1, music: "" }],
          17: [{ line: 1, music: "" }],
          18: [{ line: 1, music: "" }],
          19: [{ line: 1, music: "" }],
          20: [{ line: 1, music: "" }],
          21: [{ line: 1, music: "" }],
          22: [{ line: 1, music: "" }],
          23: [{ line: 1, music: "" }],
          24: [{ line: 1, music: "" }],
          25: [{ line: 1, music: "" }],
          26: [{ line: 1, music: "" }],
          27: [{ line: 1, music: "" }],
          28: [{ line: 1, music: "" }],
          29: [{ line: 1, music: "" }],
          30: [{ line: 1, music: "" }],
          31: [{ line: 1, music: "" }],
          32: [{ line: 1, music: "" }],
          33: [{ line: 1, music: "" }]
        }
      },
      "SADMAX (Stranger Things)": {
        prefix: "sadmax_",
        chapters: ["Prolog"],
        triggers: {
          0: [{ line: 1, music: "e5jqa4" }]
        }
      },
      "Gefangen (Star Wars)": {
        prefix: "gefangen_",
        chapters: ["Tag 1","Tag 2","Tag 3","Tag 4","Tag 5","Tag 6 - Morgendämmerung"],
        triggers: {
          0: [{ line: 1, music: "g8xtlu" }, { line: 150, music: "z8pr7g" }],
          1: [{ line: 1, music: "z8pr7g" }],
          2: [{ line: 1, music: "z8pr7g" }],
          3: [{ line: 1, music: "z8pr7g" }],
          4: [{ line: 1, music: "z8pr7g" }],
          5: [{ line: 1, music: "z8pr7g" }]
        }
      },
      "Veilchen für Vi (Arcane)": {
        prefix: "vfv_",
        chapters: ["Veilchen für Vi"],
        triggers: {
          0: [{ line: 1, music: "rwvxfl" }]
        }
      },
      "Erinnermich, der Harry Potter Adventskalender 2024": {
        prefix: "erinnermich24_",
        chapters: [
          "Vorwort","Harry Potter","Severus Snape","Fred Weasley","George Weasley",
          "Luna Lovegood","Draco Malfoy","Sirius Black","Remus Lupin","Bellatrix Lestrange",
          "Lucius Malfoy","Ginny Weasley","Ron Weasley","Neville Longbottom","Albus Dumbledore",
          "Viktor Krum","Molly Weasley","Percy Weasley","Lily Potter","James Potter",
          "Nymphadora Tonks","Minerva McGonagall","Dobby, der freie Elf","Rubeus Hagrid","Hermine Granger",
          "Nachwort"
        ],
        triggers: {
          0: [{ line: 1, music: "rs01xb" }],
          1: [{ line: 1, music: "rs01xb" }],
          2: [{ line: 1, music: "" }],
          3: [{ line: 1, music: "" }],
          4: [{ line: 1, music: "" }],
          5: [{ line: 1, music: "" }],
          6: [{ line: 1, music: "" }],
          7: [{ line: 1, music: "" }],
          8: [{ line: 1, music: "" }],
          9: [{ line: 1, music: "" }],
          10: [{ line: 1, music: "" }],
          11: [{ line: 1, music: "" }],
          12: [{ line: 1, music: "" }],
          13: [{ line: 1, music: "" }],
          14: [{ line: 1, music: "" }],
          15: [{ line: 1, music: "" }],
          16: [{ line: 1, music: "" }],
          17: [{ line: 1, music: "" }],
          18: [{ line: 1, music: "" }],
          19: [{ line: 1, music: "" }],
          20: [{ line: 1, music: "" }],
          21: [{ line: 1, music: "" }],
          22: [{ line: 1, music: "" }],
          23: [{ line: 1, music: "" }],
          24: [{ line: 1, music: "" }],
          25: [{ line: 1, music: "rs01xb" }]
        }
      },
      "化身的职责 - Die Pflicht eines Avatars": {
        prefix: "dpea_",
        chapters: ["Die Pflicht eines Avatars"],
        triggers: {
          0: [{ line: 1, music: "834z4h" }]
        }
      }
    };

    const storySelect   = document.getElementById("storySelect");
    const chapterSelect = document.getElementById("chapterSelect");
    const content       = document.getElementById("storyContent");
    const audioTrigger  = document.getElementById("audioTrigger");
    const volumeSlider  = document.getElementById("volumeSlider");
    const plusBtn       = document.getElementById("autoscrollPlus");
    const minusBtn      = document.getElementById("autoscrollMinus");

    let currentStory    = null;
    let currentChapter  = 0;
    let currentTriggers = [];
    let currentMusicID  = null;

    let scrollSpeed = 0;
    let scrollInterval = null;
    const SCROLL_TICK = 75;

    function updateAutoscroll() {
      if (scrollInterval) clearInterval(scrollInterval);
      if (scrollSpeed > 0) {
        scrollInterval = setInterval(() => {
          content.scrollTop += scrollSpeed;
        }, SCROLL_TICK);
      }
    }

    plusBtn.addEventListener('click', () => {
      scrollSpeed += 0.5;
      updateAutoscroll();
    });

    minusBtn.addEventListener('click', () => {
      scrollSpeed = Math.max(0, scrollSpeed - 0.5);
      updateAutoscroll();
    });

    Object.keys(stories).forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      storySelect.appendChild(opt);
    });

    storySelect.addEventListener("change", () => {
      chapterSelect.innerHTML = '<option disabled selected>Kapitel wählen</option>';
      currentStory = stories[storySelect.value];
      currentChapter = 0;
      currentStory.chapters.forEach((t, i) => {
        const o = document.createElement("option");
        o.value = i;
        const hasMusic = (currentStory.triggers[i] || []).some(trig => trig.music !== "");
        o.textContent = `${i+1}. ${t}${hasMusic ? " | ♫" : ""}`;
        chapterSelect.appendChild(o);
      });
      loadChapter(0);
    });

    chapterSelect.addEventListener("change", () => {
      currentChapter = +chapterSelect.value;
      loadChapter(currentChapter);
    });

    function insertImageTriggers() {
      const lineEls = content.querySelectorAll('.line');
      currentTriggers.forEach(trig => {
        if (trig.image) {
          const el = lineEls[trig.line - 1];
          if (el) {
            const img = document.createElement('img');
            img.src = trig.image;
            el.parentNode.insertBefore(img, el);
          }
        }
      });
    }

    function loadChapter(idx) {
      document.querySelectorAll('audio').forEach(a => {
        a.pause();
        a.currentTime = 0;
        a.src = '';
      });
      scrollSpeed = 0;
      updateAutoscroll();
      content.scrollTop = 0;

      const s = currentStory;
      fetch(`https://raw.githubusercontent.com/FNK-Author/FNK_Fanfictions/main/${s.prefix}${idx+1}.txt`)
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(txt => {
          const lines = txt.split('\n');
          content.innerHTML = lines.map(l => `<div class="line">${l}</div>`).join('');
          content.scrollTop = 0;
          currentTriggers = s.triggers[idx] || [];
          insertImageTriggers();
        })
        .catch(_ => {
          content.innerHTML = `<div class="line">Leider kein Kapitel gefunden.</div>`;
          content.scrollTop = 0;
          currentTriggers = [];
        });
      chapterSelect.selectedIndex = idx + 1;
    }

    content.addEventListener('scroll', () => {
      const scrollTop = content.scrollTop;
      const lineEls = content.querySelectorAll('.line');
      const lineHeight = lineEls[0]?.offsetHeight || 0;

      currentTriggers.forEach(trig => {
        if (trig.music === currentMusicID) return;
        const el = lineEls[trig.line - 1];
        if (!el) return;
        const offset = el.offsetTop;
        if (Math.abs(offset - scrollTop) < lineHeight / 2) {
          currentMusicID = trig.music;
          audioTrigger.src = `https://files.catbox.moe/${trig.music}.mp3`;
          if (audioTrigger.volume > 0) audioTrigger.play();
          lineEls.forEach(l => l.classList.remove('playing'));
          el.classList.add('playing');
        }
      });
    });

    function changeChapter(dir) {
      if (!currentStory) return;
      const n = currentChapter + dir;
      if (n >= 0 && n < currentStory.chapters.length) {
        currentChapter = n;
        loadChapter(n);
      }
    }

    volumeSlider.addEventListener('input', () => {
      audioTrigger.volume = volumeSlider.value;
    });
  </script>
</body>
</html>
